class t{constructor(t,e){this.x=t,this.y=e}set(t,e){this.x=t,this.y=e}}class e extends t{constructor(){super(0,0),this.down=!1,this.previous=new t(0,0)}}class s{constructor(){this.eventListeners=new Map}addEventListener(t,e){const s=this.eventListeners.get(t)||new Set;s.add(e),this.eventListeners.set(t,s)}removeEventListener(t,e){const s=this.eventListeners.get(t);s&&s.delete(e)}dispatchEvent(t,e){const s=this.eventListeners.get(t);s&&[...s].forEach((t=>t(e)))}}const i=(t,e,s,i)=>{const o=(s-t)**2,n=(i-e)**2;return Math.sqrt(o+n)},o=(t,e,s,i,o)=>n=>{const r=t[n],h=t[n+1],a=t[n+2],c=t[n+3];return r===e&&h===s&&a===i&&c===o},n="draw",r="erase",h="fill",a="disabled",c=[n,r];class d extends s{constructor(t,s={}){if("undefined"==typeof window)throw new Error("Looks like we're not running in a browser");if(super(),t instanceof window.Node&&"CANVAS"===t.tagName)this.canvas=t;else{if("string"!=typeof t)throw new Error(`can't look for canvas based on '${t}'`);this.canvas=document.querySelector(t)}if(!this.canvas)throw new Error("canvas not found");this.canvas.width=s.width||this.canvas.width,this.canvas.height=s.height||this.canvas.height,this.mouse=new e;const i=t=>{t.cancelable&&t.preventDefault();(t.getCoalescedEvents?.()||[t]).forEach((t=>{const e=t.offsetX,s=t.offsetY,{mouse:i}=this;if(i.down&&c.includes(this.modeInternal)){const{x:t,y:o}=this.draw(e,s,i.previous.x,i.previous.y);this.dirty||this.modeInternal!==n||e===i.x&&s===i.y||(this.dirty=!0,this.fireDirty()),i.set(e,s),i.previous.set(t,o)}else i.set(e,s)}))},o=t=>{if(t.cancelable&&t.preventDefault(),i(t),this.mode===h)return void this.fill();const{mouse:e}=this;e.previous.set(e.x,e.y),e.down=!0,this.beginStroke(e.previous.x,e.previous.y)},r=t=>{if(this.mode===h)return;const{mouse:e}=this;if(e.down){if(e.down=!1,e.x===t.offsetX&&e.y===t.offsetY&&c.includes(this.mode)){const{x:t,y:s}=this.draw(e.x,e.y,e.previous.x,e.previous.y);e.previous.set(t,s)}this.endStroke(e.x,e.y)}};this.canvas.addEventListener("pointermove",i),this.canvas.addEventListener("pointerdown",o),document.addEventListener("pointerup",r),this.destroy=()=>{this.clear(),this.canvas.removeEventListener("pointermove",i),this.canvas.removeEventListener("pointerdown",o),document.removeEventListener("pointerup",r)},this.context=this.canvas.getContext("2d"),this.context.globalCompositeOperation="source-over",this.context.globalAlpha=1,this.context.strokeStyle=s.color||"rgba(0,0,0,1)",this.context.lineCap="round",this.context.lineJoin="round",this.filling=!1,this.fillStack=[],this.recordStrokes=!1,this.strokeMemory=[],this.smoothing=.85,this.thickness=2,this.targetThickness=this.thickness,this.weightInternal=this.thickness,this.maxWeight=this.thickness+10,this.modeInternal=n,this.adaptiveStroke=!0,["weight","smoothing","adaptiveStroke","mode"].forEach((t=>{void 0!==s[t]&&(this[t]=s[t])}))}beginStroke(e,s){this.context.beginPath(),this.context.moveTo(e,s),this.recordStrokes&&(this.strokeTimestamp=performance.now(),this.strokeMemory.push({point:new t(e,s),time:performance.now()-this.strokeTimestamp})),this.dispatchEvent("strokestart",{x:e,y:s})}endStroke(e,s){this.context.closePath(),this.recordStrokes&&this.strokeMemory.push({point:new t(e,s),time:performance.now()-this.strokeTimestamp}),this.dispatchEvent("strokeend",{x:e,y:s}),this.recordStrokes&&this.dispatchEvent("strokerecorded",{stroke:this.currentStroke}),this.strokeMemory=[],delete this.strokeTimestamp}draw(e,s,o,n){this.recordStrokes&&(this.strokeMemory.push({point:new t(e,s),time:performance.now()-this.strokeTimestamp}),this.dispatchEvent("pointdrawn",{stroke:this.currentStroke}));const{context:r}=this,h=i(e,s,o,n),a=Math.min(.87,this.smoothing+(h-60)/3e3),c=e-(e-o)*a,d=s-(s-n)*a,l=i(c,d,o,n);return this.adaptiveStroke?(this.targetThickness=(l-1)/49*(this.maxWeight-this.weightInternal)+this.weightInternal,this.thickness>this.targetThickness?this.thickness-=.5:this.thickness<this.targetThickness&&(this.thickness+=.5),r.lineWidth=this.thickness):r.lineWidth=this.weightInternal,r.quadraticCurveTo(o,n,c,d),r.stroke(),{x:c,y:d}}get color(){return this.context.strokeStyle}set color(t){if("string"!=typeof t)throw new Error("wrong argument type");this.context.strokeStyle=t}get weight(){return this.weightInternal}set weight(t){if("number"!=typeof t)throw new Error("wrong argument type");this.weightInternal=t,this.thickness=t,this.targetThickness=t,this.maxWeight=t+10}get mode(){return this.modeInternal}set mode(t){if("string"!=typeof t)throw new Error("wrong argument type");switch(t){case r:this.modeInternal=r,this.context.globalCompositeOperation="destination-out";break;case h:this.modeInternal=h,this.context.globalCompositeOperation="source-over";break;case a:this.modeInternal=a;break;default:this.modeInternal=n,this.context.globalCompositeOperation="source-over"}}get currentStroke(){return{points:this.strokeMemory.slice(),mode:this.mode,weight:this.weight,smoothing:this.smoothing,color:this.color,adaptiveStroke:this.adaptiveStroke}}isDirty(){return!!this.dirty}fireDirty(){this.dispatchEvent("dirty")}clear(){this.isDirty&&(this.dirty=!1,this.dispatchEvent("clean"),this.modeInternal===r?(this.modeInternal=n,this.context.clearRect(-10,-10,this.canvas.width+20,this.canvas.height+20),this.modeInternal=r):this.context.clearRect(-10,-10,this.canvas.width+20,this.canvas.height+20))}toImage(){return this.canvas.toDataURL()}fill(){const{mouse:t}=this,{context:e}=this,s=Array.from(e.getImageData(t.x,t.y,1,1).data);if(this.filling)this.fillStack.push([t.x,t.y,s]);else{const{x:e,y:i}=t;this.dispatchEvent("fillstart",{x:e,y:i}),this.filling=!0,setTimeout((()=>{this.floodFill(t.x,t.y,s)}),100)}}floodFill(t,e,s){const{context:i}=this,n=Math.floor(t),r=Math.floor(e),h=i.canvas.width,a=i.canvas.height,c=[[n,r]],d=(t=>{const e=t.match(/^#?([\da-f]{2})([\da-f]{2})([\da-f]{2})$/i);return[parseInt(e[1],16),parseInt(e[2],16),parseInt(e[3],16)]})(this.color),l=i.getImageData(0,0,i.canvas.width,i.canvas.height),p=Math.min(10*i.globalAlpha*255,255),m=((t,e,s,i,n,r)=>{const h=o(t,...n);return o=>{t[o]=e,t[o+1]=s,t[o+2]=i,t[o+3]=r,h(o+4)||(t[o+4]=.01*t[o+4]+.99*e,t[o+4+1]=.01*t[o+4+1]+.99*s,t[o+4+2]=.01*t[o+4+2]+.99*i,t[o+4+3]=.01*t[o+4+3]+.99*r),h(o-4)||(t[o-4]=.01*t[o-4]+.99*e,t[o-4+1]=.01*t[o-4+1]+.99*s,t[o-4+2]=.01*t[o-4+2]+.99*i,t[o-4+3]=.01*t[o-4+3]+.99*r)}})(l.data,...d,s,p),v=o(l.data,...s);if(o(l.data,...d,255)(4*(r*i.canvas.width+n)))return this.filling=!1,void this.dispatchEvent("fillend",{});for(;c.length;){const t=c.pop(),e=t[0];let s=t[1],i=4*(s*h+e);for(;s-- >=0&&v(i);)i-=4*h;i+=4*h,++s;let o=!1,n=!1;for(;s++<a-1&&v(i);)m(i),e>0&&(v(i-4)?o||(c.push([e-1,s]),o=!0):o&&(o=!1)),e<h-1&&(v(i+4)?n||(c.push([e+1,s]),n=!0):n&&(n=!1)),i+=4*h}i.putImageData(l,0,0),this.fillStack.length?this.floodFill(...this.fillStack.shift()):(this.filling=!1,this.dispatchEvent("fillend",{}))}}export{d as Atrament};
