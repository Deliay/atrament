var t=null;try{var e="undefined"!=typeof module&&"function"==typeof module.require&&module.require("worker_threads")||"function"==typeof __non_webpack_require__&&__non_webpack_require__("worker_threads")||"function"==typeof require&&require("worker_threads");t=e.Worker}catch(t){}function s(e,s,i){var g=void 0===s?null:s,o=function(t,e){return Buffer.from(t,"base64").toString(e?"utf16":"utf8")}(e,void 0!==i&&i),I=o.indexOf("\n",10)+1,n=o.substring(I)+(g?"//# sourceMappingURL="+g:"");return function(e){return new t(n,Object.assign({},e,{eval:!0}))}}function i(t,e,s){var i=void 0===e?null:e,g=function(t,e){var s=atob(t);if(e){for(var i=new Uint8Array(s.length),g=0,o=s.length;g<o;++g)i[g]=s.charCodeAt(g);return String.fromCharCode.apply(null,new Uint16Array(i.buffer))}return s}(t,void 0!==s&&s),o=g.indexOf("\n",10)+1,I=g.substring(o)+(i?"//# sourceMappingURL="+i:""),n=new Blob([I],{type:"application/javascript"});return URL.createObjectURL(n)}var g="[object process]"===Object.prototype.toString.call("undefined"!=typeof process?process:0);var o,I,n,r=(o="Lyogcm9sbHVwLXBsdWdpbi13ZWItd29ya2VyLWxvYWRlciAqLwooZnVuY3Rpb24gKCkgewogICd1c2Ugc3RyaWN0JzsKCiAgY29uc3QgaGV4VG9SZ2IgPSAoaGV4Q29sb3IpID0+IHsKICAgIC8vIFNpbmNlIGlucHV0IHR5cGUgY29sb3IgcHJvdmlkZXMgaGV4IGFuZCBJbWFnZURhdGEgYWNjZXB0cyBSR0IgbmVlZCB0byB0cmFuc2Zvcm0KICAgIGNvbnN0IG0gPSBoZXhDb2xvci5tYXRjaCgvXiM/KFtcZGEtZl17Mn0pKFtcZGEtZl17Mn0pKFtcZGEtZl17Mn0pJC9pKTsKICAgIHJldHVybiBbCiAgICAgIHBhcnNlSW50KG1bMV0sIDE2KSwKICAgICAgcGFyc2VJbnQobVsyXSwgMTYpLAogICAgICBwYXJzZUludChtWzNdLCAxNiksCiAgICBdOwogIH07CgogIGNvbnN0IG1hdGNoQ29sb3IgPSAoZGF0YSwgY29tcFIsIGNvbXBHLCBjb21wQiwgY29tcEEpID0+IChwaXhlbFBvcykgPT4gewogICAgLy8gUGl4ZWwgY29sb3IgZXF1YWxzIGNvbXAgY29sb3I/CiAgICBjb25zdCByID0gZGF0YVtwaXhlbFBvc107CiAgICBjb25zdCBnID0gZGF0YVtwaXhlbFBvcyArIDFdOwogICAgY29uc3QgYiA9IGRhdGFbcGl4ZWxQb3MgKyAyXTsKICAgIGNvbnN0IGEgPSBkYXRhW3BpeGVsUG9zICsgM107CgogICAgcmV0dXJuIChyID09PSBjb21wUiAmJiBnID09PSBjb21wRyAmJiBiID09PSBjb21wQiAmJiBhID09PSBjb21wQSk7CiAgfTsKCiAgLyogZXNsaW50LWRpc2FibGUgbm8tcGFyYW0tcmVhc3NpZ24gKi8KICBjb25zdCBjb2xvclBpeGVsID0gKGRhdGEsIGZpbGxSLCBmaWxsRywgZmlsbEIsIHN0YXJ0Q29sb3IsIGFscGhhKSA9PiB7CiAgICBjb25zdCBtYXRjaGVyID0gbWF0Y2hDb2xvcihkYXRhLCAuLi5zdGFydENvbG9yKTsKCiAgICByZXR1cm4gKHBpeGVsUG9zKSA9PiB7CiAgICAgIC8vIFVwZGF0ZSBmaWxsIGNvbG9yIGluIG1hdHJpeAogICAgICBkYXRhW3BpeGVsUG9zXSA9IGZpbGxSOwogICAgICBkYXRhW3BpeGVsUG9zICsgMV0gPSBmaWxsRzsKICAgICAgZGF0YVtwaXhlbFBvcyArIDJdID0gZmlsbEI7CiAgICAgIGRhdGFbcGl4ZWxQb3MgKyAzXSA9IGFscGhhOwoKICAgICAgaWYgKCFtYXRjaGVyKHBpeGVsUG9zICsgNCkpIHsKICAgICAgICBkYXRhW3BpeGVsUG9zICsgNF0gPSBkYXRhW3BpeGVsUG9zICsgNF0gKiAwLjAxICsgZmlsbFIgKiAwLjk5OwogICAgICAgIGRhdGFbcGl4ZWxQb3MgKyA0ICsgMV0gPSBkYXRhW3BpeGVsUG9zICsgNCArIDFdICogMC4wMSArIGZpbGxHICogMC45OTsKICAgICAgICBkYXRhW3BpeGVsUG9zICsgNCArIDJdID0gZGF0YVtwaXhlbFBvcyArIDQgKyAyXSAqIDAuMDEgKyBmaWxsQiAqIDAuOTk7CiAgICAgICAgZGF0YVtwaXhlbFBvcyArIDQgKyAzXSA9IGRhdGFbcGl4ZWxQb3MgKyA0ICsgM10gKiAwLjAxICsgYWxwaGEgKiAwLjk5OwogICAgICB9CgogICAgICBpZiAoIW1hdGNoZXIocGl4ZWxQb3MgLSA0KSkgewogICAgICAgIGRhdGFbcGl4ZWxQb3MgLSA0XSA9IGRhdGFbcGl4ZWxQb3MgLSA0XSAqIDAuMDEgKyBmaWxsUiAqIDAuOTk7CiAgICAgICAgZGF0YVtwaXhlbFBvcyAtIDQgKyAxXSA9IGRhdGFbcGl4ZWxQb3MgLSA0ICsgMV0gKiAwLjAxICsgZmlsbEcgKiAwLjk5OwogICAgICAgIGRhdGFbcGl4ZWxQb3MgLSA0ICsgMl0gPSBkYXRhW3BpeGVsUG9zIC0gNCArIDJdICogMC4wMSArIGZpbGxCICogMC45OTsKICAgICAgICBkYXRhW3BpeGVsUG9zIC0gNCArIDNdID0gZGF0YVtwaXhlbFBvcyAtIDQgKyAzXSAqIDAuMDEgKyBhbHBoYSAqIDAuOTk7CiAgICAgIH0KICAgIH07CiAgfTsKICAvKiBlc2xpbnQtZW5hYmxlIG5vLXBhcmFtLXJlYXNzaWduICovCgogIGNvbnN0IGZsb29kRmlsbCA9ICh7CiAgICBpbWFnZSwKICAgIHdpZHRoLAogICAgaGVpZ2h0LAogICAgY29sb3IsCiAgICBnbG9iYWxBbHBoYSwKICAgIHN0YXJ0WCwKICAgIHN0YXJ0WSwKICAgIHN0YXJ0Q29sb3IsCiAgfSkgPT4gewogICAgY29uc3QgZmxvb3JYID0gTWF0aC5mbG9vcihzdGFydFgpOwogICAgY29uc3QgZmxvb3JZID0gTWF0aC5mbG9vcihzdGFydFkpOwogICAgY29uc3QgcGl4ZWxTdGFjayA9IFtbZmxvb3JYLCBmbG9vclldXTsKICAgIC8vIGhleCBuZWVkcyB0byBiZSB0cmFzZm9ybWVkIHRvIHJnYiBzaW5jZSBjb2xvckxheWVyIGFjY2VwdHMgUkdCCiAgICBjb25zdCBmaWxsQ29sb3IgPSBoZXhUb1JnYihjb2xvcik7CiAgICBjb25zdCBhbHBoYSA9IE1hdGgubWluKGdsb2JhbEFscGhhICogMTAgKiAyNTUsIDI1NSk7CiAgICBjb25zdCBjb2xvclBpeGVsJDEgPSBjb2xvclBpeGVsKGltYWdlLCAuLi5maWxsQ29sb3IsIHN0YXJ0Q29sb3IsIGFscGhhKTsKICAgIGNvbnN0IG1hdGNoQ29sb3IkMSA9IG1hdGNoQ29sb3IoaW1hZ2UsIC4uLnN0YXJ0Q29sb3IpOwogICAgY29uc3QgbWF0Y2hGaWxsQ29sb3IgPSBtYXRjaENvbG9yKGltYWdlLCAuLi5bLi4uZmlsbENvbG9yLCAyNTVdKTsKCiAgICAvLyBjaGVjayBpZiB3ZSdyZSB0cnlpbmcgdG8gZmlsbCB3aXRoIHRoZSBzYW1lIGNvbG91ciwgaWYgc28sIHN0b3AKICAgIGlmIChtYXRjaEZpbGxDb2xvcigoZmxvb3JZICogd2lkdGggKyBmbG9vclgpICogNCkpIHsKICAgICAgcmV0dXJuIGltYWdlOwogICAgfQoKICAgIHdoaWxlIChwaXhlbFN0YWNrLmxlbmd0aCkgewogICAgICBjb25zdCBuZXdQb3MgPSBwaXhlbFN0YWNrLnBvcCgpOwogICAgICBjb25zdCB4ID0gbmV3UG9zWzBdOwogICAgICBsZXQgeSA9IG5ld1Bvc1sxXTsKCiAgICAgIGxldCBwaXhlbFBvcyA9ICh5ICogd2lkdGggKyB4KSAqIDQ7CgogICAgICB3aGlsZSAoeS0tID49IDAgJiYgbWF0Y2hDb2xvciQxKHBpeGVsUG9zKSkgewogICAgICAgIHBpeGVsUG9zIC09IHdpZHRoICogNDsKICAgICAgfQogICAgICBwaXhlbFBvcyArPSB3aWR0aCAqIDQ7CgogICAgICArK3k7CgogICAgICBsZXQgcmVhY2hMZWZ0ID0gZmFsc2U7CiAgICAgIGxldCByZWFjaFJpZ2h0ID0gZmFsc2U7CgogICAgICB3aGlsZSAoeSsrIDwgaGVpZ2h0IC0gMSAmJiBtYXRjaENvbG9yJDEocGl4ZWxQb3MpKSB7CiAgICAgICAgY29sb3JQaXhlbCQxKHBpeGVsUG9zKTsKCiAgICAgICAgaWYgKHggPiAwKSB7CiAgICAgICAgICBpZiAobWF0Y2hDb2xvciQxKHBpeGVsUG9zIC0gNCkpIHsKICAgICAgICAgICAgaWYgKCFyZWFjaExlZnQpIHsKICAgICAgICAgICAgICBwaXhlbFN0YWNrLnB1c2goW3ggLSAxLCB5XSk7CiAgICAgICAgICAgICAgcmVhY2hMZWZ0ID0gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIGlmIChyZWFjaExlZnQpIHsKICAgICAgICAgICAgcmVhY2hMZWZ0ID0gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBpZiAoeCA8IHdpZHRoIC0gMSkgewogICAgICAgICAgaWYgKG1hdGNoQ29sb3IkMShwaXhlbFBvcyArIDQpKSB7CiAgICAgICAgICAgIGlmICghcmVhY2hSaWdodCkgewogICAgICAgICAgICAgIHBpeGVsU3RhY2sucHVzaChbeCArIDEsIHldKTsKICAgICAgICAgICAgICByZWFjaFJpZ2h0ID0gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIGlmIChyZWFjaFJpZ2h0KSB7CiAgICAgICAgICAgIHJlYWNoUmlnaHQgPSBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHBpeGVsUG9zICs9IHdpZHRoICogNDsKICAgICAgfQogICAgfQoKICAgIHJldHVybiBpbWFnZTsKICB9OwoKICBjb25zdCBvbk1lc3NhZ2UgPSAoeyBkYXRhIH0pID0+IHsKICAgIGNvbnN0IHJlc3VsdCA9IGZsb29kRmlsbChkYXRhKTsKICAgIGdsb2JhbFRoaXMucG9zdE1lc3NhZ2UoeyB0eXBlOiAnZmlsbC1yZXN1bHQnLCByZXN1bHQgfSwgW3Jlc3VsdC5idWZmZXJdKTsKICB9OwoKICBnbG9iYWxUaGlzLmFkZEV2ZW50TGlzdGVuZXIoJ21lc3NhZ2UnLCBvbk1lc3NhZ2UpOwoKfSkoKTsKLy8jIHNvdXJjZU1hcHBpbmdVUkw9d29ya2VyLmpzLm1hcAoK",I=null,n=!1,g?s(o,I,n):function(t,e,s){var g;return function(o){return g=g||i(t,e,s),new Worker(g,o)}}(o,I,n));class h{constructor(t,e){this.x=t,this.y=e}set(t,e){this.x=t,this.y=e}}class C extends h{constructor(){super(0,0),this.down=!1,this.previous=new h(0,0)}}class a{constructor(){this.eventListeners=new Map}addEventListener(t,e){const s=this.eventListeners.get(t)||new Set;s.add(e),this.eventListeners.set(t,s)}removeEventListener(t,e){const s=this.eventListeners.get(t);s&&s.delete(e)}dispatchEvent(t,e){const s=this.eventListeners.get(t);s&&[...s].forEach((t=>t(e)))}}const c=(t,e,s,i)=>{const g=(s-t)**2,o=(i-e)**2;return Math.sqrt(g+o)},A=t=>e=>{e.isPrimary&&(e.cancelable&&e.preventDefault(),t(e))},l="draw",d="erase",b="fill",p="disabled",G=[l,d];class v extends a{constructor(t,e={}){if("undefined"==typeof window)throw new Error("Looks like we're not running in a browser");if(super(),t instanceof window.Node&&"CANVAS"===t.tagName)this.canvas=t;else{if("string"!=typeof t)throw new Error(`can't look for canvas based on '${t}'`);this.canvas=document.querySelector(t)}if(!this.canvas)throw new Error("canvas not found");this.canvas.width=e.width||this.canvas.width,this.canvas.height=e.height||this.canvas.height,this.canvas.style.touchAction="none",this.mouse=new C;const{removePointerEventListeners:s}=(({canvas:t,move:e,down:s,up:i})=>{const g=A(e),o=A(s),I=A(i);return t.addEventListener("pointermove",g),t.addEventListener("pointerdown",o),document.addEventListener("pointerup",I),{removePointerEventListeners:()=>{t.removeEventListener("pointermove",g),t.removeEventListener("pointerdown",o),document.removeEventListener("pointerup",I)}}})({canvas:this.canvas,move:this.pointerMove.bind(this),down:this.pointerDown.bind(this),up:this.pointerUp.bind(this)});this.destroy=()=>{this.clear(),s()},this.context=this.canvas.getContext("2d"),this.context.globalCompositeOperation="source-over",this.context.globalAlpha=1,this.context.strokeStyle=e.color||"rgba(0,0,0,1)",this.context.lineCap="round",this.context.lineJoin="round",this.filling=!1,this.fillStack=[],this.recordStrokes=!1,this.strokeMemory=[],this.smoothing=.85,this.thickness=2,this.targetThickness=this.thickness,this.weightInternal=this.thickness,this.maxWeight=this.thickness+10,this.modeInternal=l,this.adaptiveStroke=!0,this.setupFill(),["weight","smoothing","adaptiveStroke","mode"].forEach((t=>{void 0!==e[t]&&(this[t]=e[t])}))}pointerMove(t){(t.getCoalescedEvents?.()||[t]).forEach((t=>{const e=t.offsetX,s=t.offsetY,{mouse:i}=this;if(i.down&&G.includes(this.modeInternal)){const{x:t,y:g}=this.draw(e,s,i.previous.x,i.previous.y);this.dirty||this.modeInternal!==l||e===i.x&&s===i.y||(this.dirty=!0,this.fireDirty()),i.set(e,s),i.previous.set(t,g)}else i.set(e,s)}))}pointerDown(t){if(this.pointerMove(t),this.mode===b)return void this.fill();const{mouse:e}=this;e.previous.set(e.x,e.y),e.down=!0,this.beginStroke(e.previous.x,e.previous.y)}pointerUp(t){if(this.mode===b)return;const{mouse:e}=this;if(e.down){if(e.down=!1,e.x===t.offsetX&&e.y===t.offsetY&&G.includes(this.mode)){const{x:t,y:s}=this.draw(e.x,e.y,e.previous.x,e.previous.y);e.previous.set(t,s)}this.endStroke(e.x,e.y)}}beginStroke(t,e){this.context.beginPath(),this.context.moveTo(t,e),this.recordStrokes&&(this.strokeTimestamp=performance.now(),this.strokeMemory.push({point:new h(t,e),time:performance.now()-this.strokeTimestamp})),this.dispatchEvent("strokestart",{x:t,y:e})}endStroke(t,e){this.context.closePath(),this.recordStrokes&&this.strokeMemory.push({point:new h(t,e),time:performance.now()-this.strokeTimestamp}),this.dispatchEvent("strokeend",{x:t,y:e}),this.recordStrokes&&this.dispatchEvent("strokerecorded",{stroke:this.currentStroke}),this.strokeMemory=[],delete this.strokeTimestamp}draw(t,e,s,i){this.recordStrokes&&(this.strokeMemory.push({point:new h(t,e),time:performance.now()-this.strokeTimestamp}),this.dispatchEvent("pointdrawn",{stroke:this.currentStroke}));const{context:g}=this,o=c(t,e,s,i),I=Math.min(.87,this.smoothing+(o-60)/3e3),n=t-(t-s)*I,r=e-(e-i)*I,C=c(n,r,s,i);return this.adaptiveStroke?(this.targetThickness=(C-1)/49*(this.maxWeight-this.weightInternal)+this.weightInternal,this.thickness>this.targetThickness?this.thickness-=.5:this.thickness<this.targetThickness&&(this.thickness+=.5),g.lineWidth=this.thickness):g.lineWidth=this.weightInternal,g.quadraticCurveTo(s,i,n,r),g.stroke(),{x:n,y:r}}get color(){return this.context.strokeStyle}set color(t){if("string"!=typeof t)throw new Error("wrong argument type");this.context.strokeStyle=t}get weight(){return this.weightInternal}set weight(t){if("number"!=typeof t)throw new Error("wrong argument type");this.weightInternal=t,this.thickness=t,this.targetThickness=t,this.maxWeight=t+10}get mode(){return this.modeInternal}set mode(t){if("string"!=typeof t)throw new Error("wrong argument type");switch(t){case d:this.modeInternal=d,this.context.globalCompositeOperation="destination-out";break;case b:this.modeInternal=b,this.context.globalCompositeOperation="source-over";break;case p:this.modeInternal=p;break;default:this.modeInternal=l,this.context.globalCompositeOperation="source-over"}}get currentStroke(){return{points:this.strokeMemory.slice(),mode:this.mode,weight:this.weight,smoothing:this.smoothing,color:this.color,adaptiveStroke:this.adaptiveStroke}}isDirty(){return!!this.dirty}fireDirty(){this.dispatchEvent("dirty")}clear(){this.isDirty&&(this.dirty=!1,this.dispatchEvent("clean"),this.modeInternal===d?(this.modeInternal=l,this.context.clearRect(-10,-10,this.canvas.width+20,this.canvas.height+20),this.modeInternal=d):this.context.clearRect(-10,-10,this.canvas.width+20,this.canvas.height+20))}toImage(){return this.canvas.toDataURL()}setupFill(){this.fillWorker=new r,this.fillWorker.addEventListener("message",(({data:t})=>{if("fill-result"===t.type){this.filling=!1,this.dispatchEvent("fillend",{});const e=new ImageData(t.result,this.canvas.width,this.canvas.height);this.context.putImageData(e,0,0),this.fillStack.length>0&&this.postToFillWorker(this.fillStack.shift())}}))}fill(){const{x:t,y:e}=this.mouse;this.dispatchEvent("fillstart",{x:t,y:e});const s=Array.from(this.context.getImageData(t,e,1,1).data),i={color:this.color,globalAlpha:this.context.globalAlpha,width:this.canvas.width,height:this.canvas.height,startColor:s,startX:t,startY:e};this.filling?this.fillStack.push(i):(this.filling=!0,this.postToFillWorker(i))}postToFillWorker(t){const e=this.context.getImageData(0,0,this.canvas.width,this.canvas.height).data;this.fillWorker.postMessage({image:e,...t},[e.buffer])}}export{v as Atrament};
