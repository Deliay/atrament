var t=null;try{var e="undefined"!=typeof module&&"function"==typeof module.require&&module.require("worker_threads")||"function"==typeof __non_webpack_require__&&__non_webpack_require__("worker_threads")||"function"==typeof require&&require("worker_threads");t=e.Worker}catch(t){}function s(e,s,i){var g=void 0===s?null:s,o=function(t,e){return Buffer.from(t,"base64").toString(e?"utf16":"utf8")}(e,void 0!==i&&i),I=o.indexOf("\n",10)+1,n=o.substring(I)+(g?"//# sourceMappingURL="+g:"");return function(e){return new t(n,Object.assign({},e,{eval:!0}))}}function i(t,e,s){var i=void 0===e?null:e,g=function(t,e){var s=atob(t);if(e){for(var i=new Uint8Array(s.length),g=0,o=s.length;g<o;++g)i[g]=s.charCodeAt(g);return String.fromCharCode.apply(null,new Uint16Array(i.buffer))}return s}(t,void 0!==s&&s),o=g.indexOf("\n",10)+1,I=g.substring(o)+(i?"//# sourceMappingURL="+i:""),n=new Blob([I],{type:"application/javascript"});return URL.createObjectURL(n)}var g="[object process]"===Object.prototype.toString.call("undefined"!=typeof process?process:0);var o,I,n,r=(o="Lyogcm9sbHVwLXBsdWdpbi13ZWItd29ya2VyLWxvYWRlciAqLwooZnVuY3Rpb24gKCkgewogICd1c2Ugc3RyaWN0JzsKCiAgLy8gY29sb3VyIGluZGljZXMgcGVyIHBpeGVsCiAgY29uc3QgUiA9IDA7CiAgY29uc3QgRyA9IDE7CiAgY29uc3QgQiA9IDI7CiAgY29uc3QgQSA9IDM7CgogIGNvbnN0IFBJWEVMID0gNDsKCiAgY29uc3QgaGV4VG9SZ2IgPSAoaGV4Q29sb3IpID0+IHsKICAgIC8vIFNpbmNlIGlucHV0IHR5cGUgY29sb3IgcHJvdmlkZXMgaGV4IGFuZCBJbWFnZURhdGEgYWNjZXB0cyBSR0IgbmVlZCB0byB0cmFuc2Zvcm0KICAgIGNvbnN0IG0gPSBoZXhDb2xvci5tYXRjaCgvXiM/KFtcZGEtZl17Mn0pKFtcZGEtZl17Mn0pKFtcZGEtZl17Mn0pJC9pKTsKICAgIHJldHVybiBbCiAgICAgIHBhcnNlSW50KG1bMV0sIDE2KSwKICAgICAgcGFyc2VJbnQobVsyXSwgMTYpLAogICAgICBwYXJzZUludChtWzNdLCAxNiksCiAgICBdOwogIH07CgogIC8vIFBpeGVsIGNvbG9yIGVxdWFscyBjb21wIGNvbG9yPwogIGNvbnN0IGNvbG9yTWF0Y2hlciA9IChkYXRhLCBjb21wUiwgY29tcEcsIGNvbXBCLCBjb21wQSkgPT4gKHBpeGVsUG9zKSA9PiAoCiAgICBkYXRhW3BpeGVsUG9zICsgUl0gPT09IGNvbXBSCiAgICAmJiBkYXRhW3BpeGVsUG9zICsgR10gPT09IGNvbXBHCiAgICAmJiBkYXRhW3BpeGVsUG9zICsgQl0gPT09IGNvbXBCCiAgICAmJiBkYXRhW3BpeGVsUG9zICsgQV0gPT09IGNvbXBBCiAgKTsKCiAgLyogZXNsaW50LWRpc2FibGUgbm8tcGFyYW0tcmVhc3NpZ24gKi8KICBjb25zdCBwaXhlbFBhaW50ZXIgPSAoZGF0YSwgZmlsbFIsIGZpbGxHLCBmaWxsQiwgc3RhcnRDb2xvciwgYWxwaGEpID0+IHsKICAgIGNvbnN0IG1hdGNoZXIgPSBjb2xvck1hdGNoZXIoZGF0YSwgLi4uc3RhcnRDb2xvcik7CgogICAgcmV0dXJuIChwaXhlbFBvcykgPT4gewogICAgICAvLyBVcGRhdGUgZmlsbCBjb2xvciBpbiBtYXRyaXgKICAgICAgZGF0YVtwaXhlbFBvc10gPSBmaWxsUjsKICAgICAgZGF0YVtwaXhlbFBvcyArIDFdID0gZmlsbEc7CiAgICAgIGRhdGFbcGl4ZWxQb3MgKyAyXSA9IGZpbGxCOwogICAgICBkYXRhW3BpeGVsUG9zICsgM10gPSBhbHBoYTsKCiAgICAgIGlmICghbWF0Y2hlcihwaXhlbFBvcyArIFBJWEVMKSkgewogICAgICAgIGRhdGFbcGl4ZWxQb3MgKyBQSVhFTCArIFJdID0gZGF0YVtwaXhlbFBvcyArIFBJWEVMICsgUl0gKiAwLjAxICsgZmlsbFIgKiAwLjk5OwogICAgICAgIGRhdGFbcGl4ZWxQb3MgKyBQSVhFTCArIEddID0gZGF0YVtwaXhlbFBvcyArIFBJWEVMICsgR10gKiAwLjAxICsgZmlsbEcgKiAwLjk5OwogICAgICAgIGRhdGFbcGl4ZWxQb3MgKyBQSVhFTCArIEJdID0gZGF0YVtwaXhlbFBvcyArIFBJWEVMICsgQl0gKiAwLjAxICsgZmlsbEIgKiAwLjk5OwogICAgICAgIGRhdGFbcGl4ZWxQb3MgKyBQSVhFTCArIEFdID0gZGF0YVtwaXhlbFBvcyArIFBJWEVMICsgQV0gKiAwLjAxICsgYWxwaGEgKiAwLjk5OwogICAgICB9CgogICAgICBpZiAoIW1hdGNoZXIocGl4ZWxQb3MgLSBQSVhFTCkpIHsKICAgICAgICBkYXRhW3BpeGVsUG9zIC0gUElYRUwgKyBSXSA9IGRhdGFbcGl4ZWxQb3MgLSBQSVhFTCArIFJdICogMC4wMSArIGZpbGxSICogMC45OTsKICAgICAgICBkYXRhW3BpeGVsUG9zIC0gUElYRUwgKyBHXSA9IGRhdGFbcGl4ZWxQb3MgLSBQSVhFTCArIEddICogMC4wMSArIGZpbGxHICogMC45OTsKICAgICAgICBkYXRhW3BpeGVsUG9zIC0gUElYRUwgKyBCXSA9IGRhdGFbcGl4ZWxQb3MgLSBQSVhFTCArIEJdICogMC4wMSArIGZpbGxCICogMC45OTsKICAgICAgICBkYXRhW3BpeGVsUG9zIC0gUElYRUwgKyBBXSA9IGRhdGFbcGl4ZWxQb3MgLSBQSVhFTCArIEFdICogMC4wMSArIGFscGhhICogMC45OTsKICAgICAgfQogICAgfTsKICB9OwogIC8qIGVzbGludC1lbmFibGUgbm8tcGFyYW0tcmVhc3NpZ24gKi8KCiAgY29uc3QgZmxvb2RGaWxsID0gKHsKICAgIGltYWdlLAogICAgd2lkdGgsCiAgICBoZWlnaHQsCiAgICBjb2xvciwKICAgIGdsb2JhbEFscGhhLAogICAgc3RhcnRYLAogICAgc3RhcnRZLAogICAgc3RhcnRDb2xvciwKICB9KSA9PiB7CiAgICBjb25zdCBmbG9vclggPSBNYXRoLmZsb29yKHN0YXJ0WCk7CiAgICBjb25zdCBmbG9vclkgPSBNYXRoLmZsb29yKHN0YXJ0WSk7CiAgICBjb25zdCBwaXhlbFN0YWNrID0gW1tmbG9vclgsIGZsb29yWV1dOwogICAgLy8gaGV4IG5lZWRzIHRvIGJlIHRyYXNmb3JtZWQgdG8gcmdiIHNpbmNlIGNvbG9yTGF5ZXIgYWNjZXB0cyBSR0IKICAgIGNvbnN0IGZpbGxDb2xvciA9IGhleFRvUmdiKGNvbG9yKTsKICAgIGNvbnN0IGFscGhhID0gTWF0aC5taW4oZ2xvYmFsQWxwaGEgKiAxMCAqIDI1NSwgMjU1KTsKICAgIGNvbnN0IGNvbG9yUGl4ZWwgPSBwaXhlbFBhaW50ZXIoaW1hZ2UsIC4uLmZpbGxDb2xvciwgc3RhcnRDb2xvciwgYWxwaGEpOwogICAgY29uc3QgbWF0Y2hTdGFydENvbG9yID0gY29sb3JNYXRjaGVyKGltYWdlLCAuLi5zdGFydENvbG9yKTsKICAgIGNvbnN0IG1hdGNoRmlsbENvbG9yID0gY29sb3JNYXRjaGVyKGltYWdlLCAuLi5bLi4uZmlsbENvbG9yLCAyNTVdKTsKCiAgICAvLyBjaGVjayBpZiB3ZSdyZSB0cnlpbmcgdG8gZmlsbCB3aXRoIHRoZSBzYW1lIGNvbG91ciwgaWYgc28sIHN0b3AKICAgIGlmIChtYXRjaEZpbGxDb2xvcigoZmxvb3JZICogd2lkdGggKyBmbG9vclgpICogUElYRUwpKSB7CiAgICAgIHJldHVybiBpbWFnZTsKICAgIH0KCiAgICB3aGlsZSAocGl4ZWxTdGFjay5sZW5ndGgpIHsKICAgICAgY29uc3QgbmV3UG9zID0gcGl4ZWxTdGFjay5wb3AoKTsKICAgICAgY29uc3QgeCA9IG5ld1Bvc1swXTsKICAgICAgbGV0IHkgPSBuZXdQb3NbMV07CgogICAgICBsZXQgcGl4ZWxQb3MgPSAoeSAqIHdpZHRoICsgeCkgKiBQSVhFTDsKCiAgICAgIHdoaWxlICh5LS0gPj0gMCAmJiBtYXRjaFN0YXJ0Q29sb3IocGl4ZWxQb3MpKSB7CiAgICAgICAgcGl4ZWxQb3MgLT0gd2lkdGggKiBQSVhFTDsKICAgICAgfQogICAgICBwaXhlbFBvcyArPSB3aWR0aCAqIFBJWEVMOwoKICAgICAgKyt5OwoKICAgICAgbGV0IHJlYWNoTGVmdCA9IGZhbHNlOwogICAgICBsZXQgcmVhY2hSaWdodCA9IGZhbHNlOwoKICAgICAgd2hpbGUgKHkrKyA8IGhlaWdodCAtIDEgJiYgbWF0Y2hTdGFydENvbG9yKHBpeGVsUG9zKSkgewogICAgICAgIGNvbG9yUGl4ZWwocGl4ZWxQb3MpOwoKICAgICAgICBpZiAoeCA+IDApIHsKICAgICAgICAgIGlmIChtYXRjaFN0YXJ0Q29sb3IocGl4ZWxQb3MgLSBQSVhFTCkpIHsKICAgICAgICAgICAgaWYgKCFyZWFjaExlZnQpIHsKICAgICAgICAgICAgICBwaXhlbFN0YWNrLnB1c2goW3ggLSAxLCB5XSk7CiAgICAgICAgICAgICAgcmVhY2hMZWZ0ID0gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIGlmIChyZWFjaExlZnQpIHsKICAgICAgICAgICAgcmVhY2hMZWZ0ID0gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBpZiAoeCA8IHdpZHRoIC0gMSkgewogICAgICAgICAgaWYgKG1hdGNoU3RhcnRDb2xvcihwaXhlbFBvcyArIFBJWEVMKSkgewogICAgICAgICAgICBpZiAoIXJlYWNoUmlnaHQpIHsKICAgICAgICAgICAgICBwaXhlbFN0YWNrLnB1c2goW3ggKyAxLCB5XSk7CiAgICAgICAgICAgICAgcmVhY2hSaWdodCA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSBpZiAocmVhY2hSaWdodCkgewogICAgICAgICAgICByZWFjaFJpZ2h0ID0gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBwaXhlbFBvcyArPSB3aWR0aCAqIFBJWEVMOwogICAgICB9CiAgICB9CgogICAgcmV0dXJuIGltYWdlOwogIH07CgogIGNvbnN0IG9uTWVzc2FnZSA9ICh7IGRhdGEgfSkgPT4gewogICAgY29uc3QgcmVzdWx0ID0gZmxvb2RGaWxsKGRhdGEpOwogICAgZ2xvYmFsVGhpcy5wb3N0TWVzc2FnZSh7IHR5cGU6ICdmaWxsLXJlc3VsdCcsIHJlc3VsdCB9LCBbcmVzdWx0LmJ1ZmZlcl0pOwogIH07CgogIGdsb2JhbFRoaXMuYWRkRXZlbnRMaXN0ZW5lcignbWVzc2FnZScsIG9uTWVzc2FnZSk7Cgp9KSgpOwovLyMgc291cmNlTWFwcGluZ1VSTD13b3JrZXIuanMubWFwCgo=",I=null,n=!1,g?s(o,I,n):function(t,e,s){var g;return function(o){return g=g||i(t,e,s),new Worker(g,o)}}(o,I,n));class h{constructor(t,e){this.x=t,this.y=e}set(t,e){this.x=t,this.y=e}}class C extends h{constructor(){super(0,0),this.down=!1,this.previous=new h(0,0)}}class c{constructor(){this.eventListeners=new Map}addEventListener(t,e){const s=this.eventListeners.get(t)||new Set;s.add(e),this.eventListeners.set(t,s)}removeEventListener(t,e){const s=this.eventListeners.get(t);s&&s.delete(e)}dispatchEvent(t,e){const s=this.eventListeners.get(t);s&&[...s].forEach((t=>t(e)))}}const a=(t,e,s,i)=>{const g=(s-t)**2,o=(i-e)**2;return Math.sqrt(g+o)},A=t=>e=>{e.isPrimary&&(e.cancelable&&e.preventDefault(),t(e))},l="draw",d="erase",G="fill",b="disabled",p=[l,d];class v extends c{constructor(t,e={}){if("undefined"==typeof window)throw new Error("Looks like we're not running in a browser");if(super(),t instanceof window.Node&&"CANVAS"===t.tagName)this.canvas=t;else{if("string"!=typeof t)throw new Error(`can't look for canvas based on '${t}'`);this.canvas=document.querySelector(t)}if(!this.canvas)throw new Error("canvas not found");this.canvas.width=e.width||this.canvas.width,this.canvas.height=e.height||this.canvas.height,this.canvas.style.touchAction="none",this.mouse=new C;const{removePointerEventListeners:s}=(({canvas:t,move:e,down:s,up:i})=>{const g=A(e),o=A(s),I=A(i);return t.addEventListener("pointermove",g),t.addEventListener("pointerdown",o),document.addEventListener("pointerup",I),{removePointerEventListeners:()=>{t.removeEventListener("pointermove",g),t.removeEventListener("pointerdown",o),document.removeEventListener("pointerup",I)}}})({canvas:this.canvas,move:this.pointerMove.bind(this),down:this.pointerDown.bind(this),up:this.pointerUp.bind(this)});this.destroy=()=>{this.clear(),s()},this.context=this.canvas.getContext("2d"),this.context.globalCompositeOperation="source-over",this.context.globalAlpha=1,this.context.strokeStyle=e.color||"rgba(0,0,0,1)",this.context.lineCap="round",this.context.lineJoin="round",this.filling=!1,this.fillStack=[],this.recordStrokes=!1,this.strokeMemory=[],this.smoothing=.85,this.thickness=2,this.targetThickness=this.thickness,this.weightInternal=this.thickness,this.maxWeight=this.thickness+10,this.modeInternal=l,this.adaptiveStroke=!0,this.setupFill(),["weight","smoothing","adaptiveStroke","mode"].forEach((t=>{void 0!==e[t]&&(this[t]=e[t])}))}pointerMove(t){(t.getCoalescedEvents?.()||[t]).forEach((t=>{const e=t.offsetX,s=t.offsetY,{mouse:i}=this;if(i.down&&p.includes(this.modeInternal)){const{x:t,y:g}=this.draw(e,s,i.previous.x,i.previous.y);this.dirty||this.modeInternal!==l||e===i.x&&s===i.y||(this.dirty=!0,this.fireDirty()),i.set(e,s),i.previous.set(t,g)}else i.set(e,s)}))}pointerDown(t){if(this.pointerMove(t),this.mode===G)return void this.fill();const{mouse:e}=this;e.previous.set(e.x,e.y),e.down=!0,this.beginStroke(e.previous.x,e.previous.y)}pointerUp(t){if(this.mode===G)return;const{mouse:e}=this;if(e.down){if(e.down=!1,e.x===t.offsetX&&e.y===t.offsetY&&p.includes(this.mode)){const{x:t,y:s}=this.draw(e.x,e.y,e.previous.x,e.previous.y);e.previous.set(t,s)}this.endStroke(e.x,e.y)}}beginStroke(t,e){this.context.beginPath(),this.context.moveTo(t,e),this.recordStrokes&&(this.strokeTimestamp=performance.now(),this.strokeMemory.push({point:new h(t,e),time:performance.now()-this.strokeTimestamp})),this.dispatchEvent("strokestart",{x:t,y:e})}endStroke(t,e){this.context.closePath(),this.recordStrokes&&this.strokeMemory.push({point:new h(t,e),time:performance.now()-this.strokeTimestamp}),this.dispatchEvent("strokeend",{x:t,y:e}),this.recordStrokes&&this.dispatchEvent("strokerecorded",{stroke:this.currentStroke}),this.strokeMemory=[],delete this.strokeTimestamp}draw(t,e,s,i){this.recordStrokes&&(this.strokeMemory.push({point:new h(t,e),time:performance.now()-this.strokeTimestamp}),this.dispatchEvent("pointdrawn",{stroke:this.currentStroke}));const{context:g}=this,o=a(t,e,s,i),I=Math.min(.87,this.smoothing+(o-60)/3e3),n=t-(t-s)*I,r=e-(e-i)*I,C=a(n,r,s,i);return this.adaptiveStroke?(this.targetThickness=(C-1)/49*(this.maxWeight-this.weightInternal)+this.weightInternal,this.thickness>this.targetThickness?this.thickness-=.5:this.thickness<this.targetThickness&&(this.thickness+=.5),g.lineWidth=this.thickness):g.lineWidth=this.weightInternal,g.quadraticCurveTo(s,i,n,r),g.stroke(),{x:n,y:r}}get color(){return this.context.strokeStyle}set color(t){if("string"!=typeof t)throw new Error("wrong argument type");this.context.strokeStyle=t}get weight(){return this.weightInternal}set weight(t){if("number"!=typeof t)throw new Error("wrong argument type");this.weightInternal=t,this.thickness=t,this.targetThickness=t,this.maxWeight=t+10}get mode(){return this.modeInternal}set mode(t){if("string"!=typeof t)throw new Error("wrong argument type");switch(t){case d:this.modeInternal=d,this.context.globalCompositeOperation="destination-out";break;case G:this.modeInternal=G,this.context.globalCompositeOperation="source-over";break;case b:this.modeInternal=b;break;default:this.modeInternal=l,this.context.globalCompositeOperation="source-over"}}get currentStroke(){return{points:this.strokeMemory.slice(),mode:this.mode,weight:this.weight,smoothing:this.smoothing,color:this.color,adaptiveStroke:this.adaptiveStroke}}isDirty(){return!!this.dirty}fireDirty(){this.dispatchEvent("dirty")}clear(){this.isDirty&&(this.dirty=!1,this.dispatchEvent("clean"),this.modeInternal===d?(this.modeInternal=l,this.context.clearRect(-10,-10,this.canvas.width+20,this.canvas.height+20),this.modeInternal=d):this.context.clearRect(-10,-10,this.canvas.width+20,this.canvas.height+20))}toImage(){return this.canvas.toDataURL()}setupFill(){this.fillWorker=new r,this.fillWorker.addEventListener("message",(({data:t})=>{if("fill-result"===t.type){this.filling=!1,this.dispatchEvent("fillend",{});const e=new ImageData(t.result,this.canvas.width,this.canvas.height);this.context.putImageData(e,0,0),this.fillStack.length>0&&this.postToFillWorker(this.fillStack.shift())}}))}fill(){const{x:t,y:e}=this.mouse;this.dispatchEvent("fillstart",{x:t,y:e});const s=Array.from(this.context.getImageData(t,e,1,1).data),i={color:this.color,globalAlpha:this.context.globalAlpha,width:this.canvas.width,height:this.canvas.height,startColor:s,startX:t,startY:e};this.filling?this.fillStack.push(i):(this.filling=!0,this.postToFillWorker(i))}postToFillWorker(t){const e=this.context.getImageData(0,0,this.canvas.width,this.canvas.height).data;this.fillWorker.postMessage({image:e,...t},[e.buffer])}}export{v as Atrament};
